{{/*
This secret provides the computed connection strings for MnemoShare.
It bridges the bundled services (PostgreSQL, MinIO) or external services
to the MnemoShare application.

Note: Redis is handled by the mnemoshare subchart directly.
*/}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mnemoshare-stack.fullname" . }}-config
  labels:
    {{- include "mnemoshare-stack.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Database configuration
  DB_DRIVER: {{ .Values.mnemoshare.database.driver | default "postgres" }}
  {{- if or .Values.postgresql.enabled (eq .Values.externalDatabase.type "postgres") }}
  POSTGRES_DSN: {{ include "mnemoshare-stack.postgresqlDsn" . | quote }}
  {{- end }}
  {{- if and (not .Values.postgresql.enabled) (eq .Values.externalDatabase.type "mongodb") }}
  MONGODB_URI: {{ .Values.externalDatabase.uri | quote }}
  {{- end }}

  # S3 Storage configuration
  S3_ENDPOINT: {{ include "mnemoshare-stack.s3Endpoint" . | quote }}
  S3_REGION: {{ .Values.externalStorage.region | default "us-east-1" | quote }}
  S3_BUCKET: {{ include "mnemoshare-stack.s3Bucket" . | quote }}
  S3_ACCESS_KEY: {{ include "mnemoshare-stack.s3AccessKey" . | quote }}
  S3_SECRET_KEY: {{ include "mnemoshare-stack.s3SecretKey" . | quote }}
  S3_USE_SSL: {{ include "mnemoshare-stack.s3UseSSL" . | quote }}

  # ClamAV configuration
  {{- if .Values.clamav.enabled }}
  DEFAULT_ICAP_URL: {{ include "mnemoshare-stack.clamavUrl" . | quote }}
  DEFAULT_ICAP_SERVICE: "avscan"
  {{- end }}

  # Security (auto-generated if not provided)
  JWT_SECRET: {{ include "mnemoshare-stack.jwtSecret" . | quote }}
  JWT_EXPIRATION: {{ .Values.mnemoshare.jwt.expiration | default "24h" | quote }}
  ENCRYPTION_KEY: {{ include "mnemoshare-stack.encryptionKey" . | quote }}

  # License (optional)
  {{- if .Values.mnemoshare.license.key }}
  LICENSE_KEY: {{ .Values.mnemoshare.license.key | quote }}
  {{- end }}
---
{{/*
ConfigMap with non-sensitive settings
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mnemoshare-stack.fullname" . }}-env
  labels:
    {{- include "mnemoshare-stack.labels" . | nindent 4 }}
data:
  API_HOST: "0.0.0.0"
  API_PORT: "8080"
