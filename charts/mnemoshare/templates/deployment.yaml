apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mnemoshare.fullname" . }}
  labels:
    {{- include "mnemoshare.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mnemoshare.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "mnemoshare.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mnemoshare.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: {{ .Chart.Name }}
        securityContext:
          {{- toYaml .Values.securityContext | nindent 12 }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.targetPort }}
          protocol: TCP
        {{- if .Values.stepCA.enabled }}
        - name: mtls
          containerPort: 8443
          protocol: TCP
        {{- end }}
        env:
        # Database Configuration (v0.6.0+ supports MongoDB, PostgreSQL, SQLite)
        - name: DB_DRIVER
          value: {{ .Values.database.driver | default "mongodb" | quote }}
        {{- if eq .Values.database.driver "mongodb" }}
        # MongoDB
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.mongodb }}{{ .Values.existingSecrets.mongodb }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: mongodb-uri
        - name: MONGODB_DATABASE
          value: {{ .Values.mongodb.external.database | quote }}
        {{- else if eq .Values.database.driver "postgres" }}
        # PostgreSQL
        - name: POSTGRES_DSN
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.postgres }}{{ .Values.existingSecrets.postgres }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: postgres-dsn
        {{- else if eq .Values.database.driver "sqlite" }}
        # SQLite (for single-instance deployments only)
        - name: SQLITE_PATH
          value: {{ .Values.database.sqlite.path | default "/var/lib/mnemoshare/mnemoshare.db" | quote }}
        {{- end }}
        # S3 Storage
        {{- if .Values.minio.enabled }}
        # MinIO is enabled - use internal MinIO service endpoint (no protocol prefix)
        - name: S3_ENDPOINT
          value: "{{ include "mnemoshare.fullname" . }}-minio:9000"
        - name: S3_REGION
          value: "us-east-1"
        - name: S3_BUCKET
          value: {{ .Values.s3.bucket | default "mnemoshare" | quote }}
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.minio.existingSecret }}{{ .Values.minio.existingSecret }}{{ else }}{{ include "mnemoshare.fullname" . }}-minio{{ end }}
              key: rootUser
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.minio.existingSecret }}{{ .Values.minio.existingSecret }}{{ else }}{{ include "mnemoshare.fullname" . }}-minio{{ end }}
              key: rootPassword
        - name: S3_USE_SSL
          value: "false"
        {{- else }}
        # External S3-compatible storage
        - name: S3_ENDPOINT
          value: {{ .Values.s3.endpoint | quote }}
        - name: S3_REGION
          value: {{ .Values.s3.region | quote }}
        - name: S3_BUCKET
          value: {{ .Values.s3.bucket | quote }}
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.s3 }}{{ .Values.existingSecrets.s3 }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: s3-access-key
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.s3 }}{{ .Values.existingSecrets.s3 }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: s3-secret-key
        - name: S3_USE_SSL
          value: {{ .Values.s3.useSSL | quote }}
        {{- end }}
        # JWT
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.jwt }}{{ .Values.existingSecrets.jwt }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: jwt-secret
        - name: JWT_EXPIRATION
          value: {{ .Values.jwt.expiration | quote }}
        # Encryption
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.encryption }}{{ .Values.existingSecrets.encryption }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: encryption-key
        # License
        - name: LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.license }}{{ .Values.existingSecrets.license }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: license-key
        {{- if .Values.license.deploymentId }}
        # Explicit deployment ID override (optional - infrastructure-based ID is recommended)
        - name: DEPLOYMENT_ID
          value: {{ .Values.license.deploymentId | quote }}
        {{- end }}
        # Infrastructure-based deployment ID generation
        # Combines namespace name + cluster UID for deterministic, portable deployment IDs
        # - Same namespace + cluster = same deployment ID (allows pod scaling)
        # - Different namespace or cluster = different deployment ID
        # - Copying database doesn't copy deployment ID
        - name: NAMESPACE_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        {{- $kubeSystemNs := (lookup "v1" "Namespace" "" "kube-system") }}
        {{- if $kubeSystemNs }}
        - name: KUBE_SYSTEM_UID
          value: {{ $kubeSystemNs.metadata.uid | quote }}
        {{- end }}
        # Application settings
        - name: API_HOST
          value: "0.0.0.0"
        - name: API_PORT
          value: "8080"
        - name: APP_URL
          value: {{ .Values.appUrl | quote }}
        - name: MAX_FILE_SIZE
          value: {{ .Values.files.maxSize | quote }}
        - name: DEFAULT_LINK_EXPIRATION
          value: {{ .Values.files.defaultLinkExpiration | quote }}
        {{- if .Values.cors.allowedOrigins }}
        - name: CORS_ALLOWED_ORIGINS
          value: {{ .Values.cors.allowedOrigins | quote }}
        {{- end }}
        - name: RATE_LIMIT_REQUESTS
          value: {{ .Values.rateLimit.requests | quote }}
        - name: RATE_LIMIT_WINDOW
          value: {{ .Values.rateLimit.window | quote }}
        # SendGrid (optional)
        {{- if .Values.sendgrid.apiKey }}
        - name: SENDGRID_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "mnemoshare.fullname" . }}-secrets
              key: sendgrid-api-key
        - name: SENDGRID_FROM_EMAIL
          value: {{ .Values.sendgrid.fromEmail | quote }}
        - name: SENDGRID_FROM_NAME
          value: {{ .Values.sendgrid.fromName | quote }}
        {{- end }}
        # ClamAV ICAP endpoint (when built-in ClamAV is enabled)
        {{- if .Values.clamav.enabled }}
        - name: DEFAULT_ICAP_URL
          value: "icap://{{ include "mnemoshare.fullname" . }}-clamav:1344"
        - name: DEFAULT_ICAP_SERVICE
          value: "avscan"
        {{- end }}
        # Extra environment variables
        {{- with .Values.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        livenessProbe:
          {{- toYaml .Values.livenessProbe | nindent 12 }}
        readinessProbe:
          {{- toYaml .Values.readinessProbe | nindent 12 }}
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
