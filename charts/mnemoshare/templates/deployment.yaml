apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mnemoshare.fullname" . }}
  labels:
    {{- include "mnemoshare.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mnemoshare.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "mnemoshare.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: api
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mnemoshare.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: {{ .Chart.Name }}
        securityContext:
          {{- toYaml .Values.securityContext | nindent 12 }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.targetPort }}
          protocol: TCP
        {{- if .Values.mtls.enabled }}
        - name: mtls
          containerPort: {{ .Values.mtls.port | default 8443 }}
          protocol: TCP
        {{- end }}
        env:
        # Database Configuration (v0.6.0+ supports MongoDB, PostgreSQL, SQLite)
        - name: DB_DRIVER
          value: {{ .Values.database.driver | default "mongodb" | quote }}
        {{- if eq .Values.database.driver "mongodb" }}
        # MongoDB
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.mongodb }}{{ .Values.existingSecrets.mongodb }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: mongodb-uri
        - name: MONGODB_DATABASE
          value: {{ .Values.mongodb.external.database | quote }}
        {{- else if eq .Values.database.driver "postgres" }}
        # PostgreSQL
        - name: POSTGRES_DSN
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.postgres }}{{ .Values.existingSecrets.postgres }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: postgres-dsn
        {{- else if eq .Values.database.driver "sqlite" }}
        # SQLite (for single-instance deployments only)
        - name: SQLITE_PATH
          value: {{ .Values.database.sqlite.path | default "/var/lib/mnemoshare/mnemoshare.db" | quote }}
        {{- end }}
        # S3 Storage
        {{- if .Values.minio.enabled }}
        # MinIO is enabled - use internal MinIO service endpoint (no protocol prefix)
        - name: S3_ENDPOINT
          value: "{{ include "mnemoshare.fullname" . }}-minio:9000"
        - name: S3_REGION
          value: "us-east-1"
        - name: S3_BUCKET
          value: {{ .Values.s3.bucket | default "mnemoshare" | quote }}
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.minio.existingSecret }}{{ .Values.minio.existingSecret }}{{ else }}{{ include "mnemoshare.fullname" . }}-minio{{ end }}
              key: rootUser
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.minio.existingSecret }}{{ .Values.minio.existingSecret }}{{ else }}{{ include "mnemoshare.fullname" . }}-minio{{ end }}
              key: rootPassword
        - name: S3_USE_SSL
          value: "false"
        {{- else }}
        # External S3-compatible storage
        - name: S3_ENDPOINT
          value: {{ .Values.s3.endpoint | quote }}
        - name: S3_REGION
          value: {{ .Values.s3.region | quote }}
        - name: S3_BUCKET
          value: {{ .Values.s3.bucket | quote }}
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.s3 }}{{ .Values.existingSecrets.s3 }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: s3-access-key
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.s3 }}{{ .Values.existingSecrets.s3 }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: s3-secret-key
        - name: S3_USE_SSL
          value: {{ .Values.s3.useSSL | quote }}
        {{- end }}
        # JWT
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.jwt }}{{ .Values.existingSecrets.jwt }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: jwt-secret
        - name: JWT_EXPIRATION
          value: {{ .Values.jwt.expiration | quote }}
        {{- if or .Values.redis.enabled .Values.redis.external.enabled }}
        # Redis - for workflow task enqueueing (manual triggers)
        # Note: REDIS_PASSWORD must be defined BEFORE REDIS_URL for $(REDIS_PASSWORD) substitution to work
        {{- if .Values.redis.external.enabled }}
        # External Redis
        {{- if .Values.redis.external.url }}
        - name: REDIS_URL
          value: {{ .Values.redis.external.url | quote }}
        {{- else }}
        {{- if or .Values.redis.external.existingSecret .Values.existingSecrets.redis }}
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.redis.external.existingSecret | default .Values.existingSecrets.redis }}
              key: {{ .Values.existingSecretKeys.redisPassword | default "redis-password" }}
        - name: REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@{{ .Values.redis.external.host }}:{{ .Values.redis.external.port | default 6379 }}/{{ .Values.redis.external.db | default 0 }}"
        {{- else }}
        - name: REDIS_URL
          value: "redis://{{ .Values.redis.external.host }}:{{ .Values.redis.external.port | default 6379 }}/{{ .Values.redis.external.db | default 0 }}"
        {{- end }}
        {{- end }}
        {{- else }}
        # Embedded Redis
        {{- if or .Values.redis.password .Values.redis.existingSecret }}
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.redis.existingSecret }}{{ .Values.redis.existingSecret }}{{ else }}{{ include "mnemoshare.fullname" . }}-redis{{ end }}
              key: redis-password
        - name: REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@{{ include "mnemoshare.fullname" . }}-redis:6379/0"
        {{- else }}
        - name: REDIS_URL
          value: "redis://{{ include "mnemoshare.fullname" . }}-redis:6379/0"
        {{- end }}
        {{- end }}
        {{- end }}
        # Encryption
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.encryption }}{{ .Values.existingSecrets.encryption }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: encryption-key
        {{- if .Values.encryption.oldKey }}
        # Old encryption key for key rotation (temporary - remove after rotation completes)
        - name: OLD_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.encryption }}{{ .Values.existingSecrets.encryption }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: old-encryption-key
        {{- end }}
        # License
        - name: LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.license }}{{ .Values.existingSecrets.license }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: license-key
        {{- if .Values.license.deploymentId }}
        # Explicit deployment ID override (optional - infrastructure-based ID is recommended)
        - name: DEPLOYMENT_ID
          value: {{ .Values.license.deploymentId | quote }}
        {{- end }}
        # Infrastructure-based deployment ID generation
        # Combines namespace name + cluster UID for deterministic, portable deployment IDs
        # - Same namespace + cluster = same deployment ID (allows pod scaling)
        # - Different namespace or cluster = different deployment ID
        # - Copying database doesn't copy deployment ID
        - name: NAMESPACE_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        {{- $kubeSystemNs := (lookup "v1" "Namespace" "" "kube-system") }}
        {{- if $kubeSystemNs }}
        - name: KUBE_SYSTEM_UID
          value: {{ $kubeSystemNs.metadata.uid | quote }}
        {{- end }}
        # Pod identity for peer discovery (multi-replica license sync)
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: HEADLESS_SERVICE_NAME
          value: {{ include "mnemoshare.fullname" . }}-headless
        # Application settings
        - name: API_HOST
          value: "0.0.0.0"
        - name: API_PORT
          value: "8080"
        - name: APP_URL
          value: {{ .Values.appUrl | quote }}
        - name: MAX_FILE_SIZE
          value: {{ .Values.files.maxSize | quote }}
        - name: DEFAULT_LINK_EXPIRATION
          value: {{ .Values.files.defaultLinkExpiration | quote }}
        {{- if .Values.cors.allowedOrigins }}
        - name: CORS_ALLOWED_ORIGINS
          value: {{ .Values.cors.allowedOrigins | quote }}
        {{- end }}
        - name: RATE_LIMIT_REQUESTS
          value: {{ .Values.rateLimit.requests | quote }}
        - name: RATE_LIMIT_WINDOW
          value: {{ .Values.rateLimit.window | quote }}
        # SendGrid (optional)
        {{- if or .Values.sendgrid.apiKey .Values.existingSecrets.sendgrid }}
        - name: SENDGRID_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.sendgrid }}{{ .Values.existingSecrets.sendgrid }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: sendgrid-api-key
        - name: SENDGRID_FROM_EMAIL
          value: {{ .Values.sendgrid.fromEmail | quote }}
        - name: SENDGRID_FROM_NAME
          value: {{ .Values.sendgrid.fromName | quote }}
        {{- end }}
        # Cloudflare Turnstile CAPTCHA (optional)
        {{- if .Values.turnstile.siteKey }}
        - name: TURNSTILE_SITE_KEY
          value: {{ .Values.turnstile.siteKey | quote }}
        {{- end }}
        {{- if or .Values.turnstile.secretKey .Values.existingSecrets.turnstile }}
        - name: TURNSTILE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.turnstile }}{{ .Values.existingSecrets.turnstile }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: turnstile-secret-key
        {{- end }}
        # Session inactivity timeout (seconds before warning modal appears)
        {{- if .Values.session }}
        - name: INACTIVITY_TIMEOUT_SECONDS
          value: {{ .Values.session.inactivityTimeoutSeconds | default 300 | quote }}
        {{- end }}
        # ClamAV ICAP endpoint
        {{- if .Values.clamav.enabled }}
        - name: DEFAULT_ICAP_URL
          value: "icap://{{ include "mnemoshare.fullname" . }}-clamav:1344"
        - name: DEFAULT_ICAP_SERVICE
          value: "avscan"
        {{- else if .Values.clamav.external.enabled }}
        - name: DEFAULT_ICAP_URL
          value: {{ .Values.clamav.external.url | quote }}
        - name: DEFAULT_ICAP_SERVICE
          value: {{ .Values.clamav.external.service | default "avscan" | quote }}
        {{- end }}
        # Disk buffer configuration (memory management for large uploads)
        {{- if .Values.diskBuffer.enabled }}
        - name: DISK_BUFFER_THRESHOLD_MB
          value: {{ .Values.diskBuffer.thresholdMB | quote }}
        - name: DISK_BUFFER_TEMP_DIR
          value: "/mnt/disk-buffer"
        - name: DISK_BUFFER_ENCRYPT
          value: {{ .Values.diskBuffer.encrypt | quote }}
        {{- end }}
        # mTLS Configuration
        {{- if .Values.mtls.enabled }}
        - name: MTLS_PORT
          value: {{ .Values.mtls.port | default 8443 | quote }}
        - name: MTLS_REQUIRE_CLIENT_CERT
          value: {{ .Values.mtls.requireClientCert | quote }}
        - name: MTLS_VERIFY_REVOCATION
          value: {{ .Values.mtls.verifyRevocation | quote }}
        {{- if .Values.mtls.tls.existingSecret }}
        - name: TLS_CERT_PATH
          value: "/etc/mtls-tls/tls.crt"
        - name: TLS_KEY_PATH
          value: "/etc/mtls-tls/tls.key"
        {{- end }}
        {{- if .Values.mtls.ca.certPath }}
        - name: MTLS_CA_CERT_PATH
          value: {{ .Values.mtls.ca.certPath | quote }}
        - name: CA_SMALLSTEP_ROOT_CERT
          value: {{ .Values.mtls.ca.certPath | quote }}
        {{- else if .Values.mtls.ca.existingSecret }}
        - name: MTLS_CA_CERT_PATH
          value: "/etc/mtls-ca/ca.crt"
        - name: CA_SMALLSTEP_ROOT_CERT
          value: "/etc/mtls-ca/ca.crt"
        {{- end }}
        {{- if .Values.mtls.ca.certPEM }}
        - name: CA_SMALLSTEP_ROOT_CERT_PEM
          value: {{ .Values.mtls.ca.certPEM | quote }}
        {{- end }}
        # CA Provider
        - name: CA_PROVIDER
          value: {{ .Values.mtls.caProvider.type | default "smallstep" | quote }}
        {{- if .Values.mtls.caProvider.url }}
        - name: CA_SMALLSTEP_URL
          value: {{ .Values.mtls.caProvider.url | quote }}
        {{- else if .Values.stepCA.enabled }}
        - name: CA_SMALLSTEP_URL
          value: "https://{{ include "mnemoshare.fullname" . }}-step-ca:9000"
        {{- end }}
        - name: CA_SMALLSTEP_PROVISIONER
          value: {{ .Values.mtls.caProvider.provisioner | default "mnemoshare" | quote }}
        {{- if .Values.mtls.caProvider.existingSecret }}
        - name: CA_SMALLSTEP_PROVISIONER_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.mtls.caProvider.existingSecret }}
              key: provisioner-key
        - name: CA_SMALLSTEP_PROVISIONER_PASS
          valueFrom:
            secretKeyRef:
              name: {{ .Values.mtls.caProvider.existingSecret }}
              key: provisioner-pass
        {{- else }}
        {{- if .Values.mtls.caProvider.provisionerKey }}
        - name: CA_SMALLSTEP_PROVISIONER_KEY
          value: {{ .Values.mtls.caProvider.provisionerKey | quote }}
        {{- end }}
        {{- if .Values.mtls.caProvider.provisionerPass }}
        - name: CA_SMALLSTEP_PROVISIONER_PASS
          value: {{ .Values.mtls.caProvider.provisionerPass | quote }}
        {{- end }}
        {{- end }}
        {{- if .Values.mtls.caProvider.rootCertPEM }}
        - name: CA_SMALLSTEP_ROOT_CERT_PEM
          value: {{ .Values.mtls.caProvider.rootCertPEM | quote }}
        {{- end }}
        {{- end }}
        # SIEM Export Configuration
        {{- if .Values.siem.enabled }}
        - name: SIEM_EXPORT_ENABLED
          value: "true"
        - name: SIEM_EXPORT_ENDPOINT
          value: {{ .Values.siem.endpoint | quote }}
        - name: SIEM_EXPORT_REGION
          value: {{ .Values.siem.region | default "us-east-1" | quote }}
        - name: SIEM_EXPORT_BUCKET
          value: {{ .Values.siem.bucket | quote }}
        - name: SIEM_EXPORT_USE_SSL
          value: {{ .Values.siem.useSSL | quote }}
        - name: SIEM_EXPORT_PATH_PREFIX
          value: {{ .Values.siem.pathPrefix | default "audit-logs/" | quote }}
        - name: SIEM_EXPORT_INTERVAL
          value: {{ .Values.siem.exportInterval | default "5m" | quote }}
        - name: SIEM_EXPORT_BATCH_SIZE
          value: {{ .Values.siem.batchSize | default 1000 | quote }}
        - name: SIEM_EXPORT_OBJECT_LOCK
          value: {{ .Values.siem.objectLock.enabled | quote }}
        - name: SIEM_EXPORT_OBJECT_LOCK_MODE
          value: {{ .Values.siem.objectLock.mode | default "governance" | quote }}
        - name: SIEM_EXPORT_RETENTION_DAYS
          value: {{ .Values.siem.objectLock.retentionDays | default 2555 | quote }}
        - name: SIEM_EXPORT_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.siem }}{{ .Values.existingSecrets.siem }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: {{ .Values.existingSecretKeys.siemAccessKey | default "siem-access-key" }}
        - name: SIEM_EXPORT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ if .Values.existingSecrets.siem }}{{ .Values.existingSecrets.siem }}{{ else }}{{ include "mnemoshare.fullname" . }}-secrets{{ end }}
              key: {{ .Values.existingSecretKeys.siemSecretKey | default "siem-secret-key" }}
        {{- end }}
        # Extra environment variables
        {{- with .Values.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        livenessProbe:
          {{- toYaml .Values.livenessProbe | nindent 12 }}
        readinessProbe:
          {{- toYaml .Values.readinessProbe | nindent 12 }}
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
        volumeMounts:
        # Writable temp directory (required for readOnlyRootFilesystem)
        - name: tmp
          mountPath: /tmp
        {{- if .Values.diskBuffer.enabled }}
        - name: disk-buffer
          mountPath: /mnt/disk-buffer
        {{- end }}
        {{- if and .Values.mtls.enabled .Values.mtls.tls.existingSecret }}
        - name: mtls-tls
          mountPath: /etc/mtls-tls
          readOnly: true
        {{- end }}
        {{- if and .Values.mtls.enabled .Values.mtls.ca.existingSecret }}
        - name: mtls-ca
          mountPath: /etc/mtls-ca
          readOnly: true
        {{- end }}
      volumes:
      # Temporary directory for runtime files
      - name: tmp
        emptyDir:
          sizeLimit: 1Gi
      {{- if .Values.diskBuffer.enabled }}
      - name: disk-buffer
        {{- if eq .Values.diskBuffer.volume.type "emptyDir" }}
        emptyDir:
          {{- if .Values.diskBuffer.volume.emptyDir.medium }}
          medium: {{ .Values.diskBuffer.volume.emptyDir.medium }}
          {{- end }}
          {{- if .Values.diskBuffer.volume.emptyDir.sizeLimit }}
          sizeLimit: {{ .Values.diskBuffer.volume.emptyDir.sizeLimit }}
          {{- end }}
        {{- else if eq .Values.diskBuffer.volume.type "ephemeral" }}
        ephemeral:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              {{- if .Values.diskBuffer.volume.ephemeral.storageClassName }}
              storageClassName: {{ .Values.diskBuffer.volume.ephemeral.storageClassName }}
              {{- end }}
              resources:
                requests:
                  storage: {{ .Values.diskBuffer.volume.ephemeral.size }}
        {{- else if eq .Values.diskBuffer.volume.type "existingClaim" }}
        persistentVolumeClaim:
          claimName: {{ .Values.diskBuffer.volume.existingClaim.claimName }}
        {{- end }}
      {{- end }}
      {{- if and .Values.mtls.enabled .Values.mtls.tls.existingSecret }}
      - name: mtls-tls
        secret:
          secretName: {{ .Values.mtls.tls.existingSecret }}
      {{- end }}
      {{- if and .Values.mtls.enabled .Values.mtls.ca.existingSecret }}
      - name: mtls-ca
        secret:
          secretName: {{ .Values.mtls.ca.existingSecret }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.dnsConfig }}
      dnsConfig:
        {{- toYaml .Values.dnsConfig | nindent 8 }}
      {{- end }}
