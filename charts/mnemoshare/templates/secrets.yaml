{{- /* Determine if the chart-managed secret is needed */ -}}
{{- $needsDB := false -}}
{{- if and (eq .Values.database.driver "mongodb") (not .Values.existingSecrets.mongodb) -}}{{ $needsDB = true }}{{- end -}}
{{- if and (eq .Values.database.driver "postgres") (not .Values.existingSecrets.postgres) -}}{{ $needsDB = true }}{{- end -}}
{{- $needsS3 := not .Values.existingSecrets.s3 -}}
{{- $needsJWT := not .Values.existingSecrets.jwt -}}
{{- $needsEncryption := not .Values.existingSecrets.encryption -}}
{{- $needsLicense := not .Values.existingSecrets.license -}}
{{- $needsSendgrid := and (not (empty .Values.sendgrid.apiKey)) (not .Values.existingSecrets.sendgrid) -}}
{{- $needsTurnstile := and (not (empty .Values.turnstile.secretKey)) (not .Values.existingSecrets.turnstile) -}}
{{- $needsSiem := and .Values.siem.enabled (not .Values.existingSecrets.siem) -}}
{{- $needsSecret := or $needsDB $needsS3 $needsJWT $needsEncryption $needsLicense $needsSendgrid $needsTurnstile $needsSiem -}}
{{- if $needsSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mnemoshare.fullname" . }}-secrets
  labels:
    {{- include "mnemoshare.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if and (eq .Values.database.driver "mongodb") (not .Values.existingSecrets.mongodb) }}
  mongodb-uri: {{ .Values.mongodb.external.uri | quote }}
  {{- end }}
  {{- if and (eq .Values.database.driver "postgres") (not .Values.existingSecrets.postgres) }}
  postgres-dsn: {{ .Values.postgres.dsn | quote }}
  {{- end }}
  {{- if not .Values.existingSecrets.s3 }}
  s3-access-key: {{ .Values.s3.accessKey | quote }}
  s3-secret-key: {{ .Values.s3.secretKey | quote }}
  {{- end }}
  {{- if not .Values.existingSecrets.jwt }}
  # JWT key is auto-generated if not provided
  jwt-secret: {{ include "mnemoshare.jwtSecret" . | quote }}
  {{- end }}
  {{- if not .Values.existingSecrets.encryption }}
  # Encryption key is auto-generated if not provided
  encryption-key: {{ include "mnemoshare.encryptionKey" . | quote }}
  {{- end }}
  {{- if .Values.encryption.oldKey }}
  # Old encryption key for key rotation - set this temporarily during master key rotation
  old-encryption-key: {{ .Values.encryption.oldKey | quote }}
  {{- end }}
  {{- if not .Values.existingSecrets.license }}
  license-key: {{ .Values.license.key | quote }}
  {{- end }}
  {{- if and .Values.sendgrid.apiKey (not .Values.existingSecrets.sendgrid) }}
  sendgrid-api-key: {{ .Values.sendgrid.apiKey | quote }}
  {{- end }}
  {{- if and .Values.turnstile.secretKey (not .Values.existingSecrets.turnstile) }}
  turnstile-secret-key: {{ .Values.turnstile.secretKey | quote }}
  {{- end }}
  {{- if and .Values.siem.enabled (not .Values.existingSecrets.siem) }}
  siem-access-key: {{ .Values.siem.accessKey | quote }}
  siem-secret-key: {{ .Values.siem.secretKey | quote }}
  {{- end }}
{{- end }}
