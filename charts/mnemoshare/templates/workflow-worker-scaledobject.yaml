{{- if and .Values.workflowWorker.enabled .Values.workflowWorker.autoscaling.enabled }}
{{- $redisAddress := "" }}
{{- if .Values.redis.external.enabled }}
{{- $redisAddress = printf "%s:%s" .Values.redis.external.host (toString (.Values.redis.external.port | default 6379)) }}
{{- else }}
{{- $redisAddress = printf "%s-redis.%s.svc.cluster.local:6379" (include "mnemoshare.fullname" .) .Release.Namespace }}
{{- end }}
{{- $hasAuth := false }}
{{- if .Values.redis.external.enabled }}
{{- $hasAuth = or (not (empty .Values.redis.external.existingSecret)) (not (empty .Values.existingSecrets.redis)) }}
{{- else }}
{{- $hasAuth = or (not (empty .Values.redis.password)) (not (empty .Values.redis.existingSecret)) }}
{{- end }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ include "mnemoshare.fullname" . }}-workflow-worker
  labels:
    {{- include "mnemoshare.labels" . | nindent 4 }}
    app.kubernetes.io/component: workflow-worker
spec:
  scaleTargetRef:
    name: {{ include "mnemoshare.fullname" . }}-workflow-worker
    {{- if .Values.workflowWorker.persistence.enabled }}
    kind: StatefulSet
    {{- end }}
  minReplicaCount: {{ .Values.workflowWorker.autoscaling.minReplicas }}
  maxReplicaCount: {{ .Values.workflowWorker.autoscaling.maxReplicas }}
  pollingInterval: {{ .Values.workflowWorker.autoscaling.pollingInterval | default 15 }}
  cooldownPeriod: {{ .Values.workflowWorker.autoscaling.cooldownPeriod | default 60 }}
  triggers:
  # Scale based on pending tasks in the default queue
  - type: redis
    metadata:
      # Use FQDN for cross-namespace resolution (KEDA runs in keda namespace)
      address: {{ $redisAddress }}
      # Asynq uses list keys for pending tasks
      listName: "asynq:default:pending"
      listLength: {{ .Values.workflowWorker.autoscaling.listLengthTarget | default "5" | quote }}
      # Use the database number
      databaseIndex: {{ .Values.redis.external.db | default "0" | quote }}
      {{- if $hasAuth }}
      enableTLS: "false"
      {{- end }}
    {{- if $hasAuth }}
    authenticationRef:
      name: {{ include "mnemoshare.fullname" . }}-redis-trigger-auth
    {{- end }}
  # Also scale based on critical queue
  - type: redis
    metadata:
      address: {{ $redisAddress }}
      listName: "asynq:critical:pending"
      listLength: {{ .Values.workflowWorker.autoscaling.listLengthTarget | default "5" | quote }}
      databaseIndex: {{ .Values.redis.external.db | default "0" | quote }}
    {{- if $hasAuth }}
    authenticationRef:
      name: {{ include "mnemoshare.fullname" . }}-redis-trigger-auth
    {{- end }}
  # And low priority queue
  - type: redis
    metadata:
      address: {{ $redisAddress }}
      listName: "asynq:low:pending"
      listLength: {{ .Values.workflowWorker.autoscaling.listLengthTarget | default "5" | quote }}
      databaseIndex: {{ .Values.redis.external.db | default "0" | quote }}
    {{- if $hasAuth }}
    authenticationRef:
      name: {{ include "mnemoshare.fullname" . }}-redis-trigger-auth
    {{- end }}
{{- end }}
