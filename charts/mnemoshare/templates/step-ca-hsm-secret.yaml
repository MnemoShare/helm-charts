{{- if and .Values.stepCA.enabled .Values.stepCA.hsm.enabled (not .Values.stepCA.hsm.pkcs11.existingPinSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mnemoshare.fullname" . }}-step-ca-hsm
  labels:
    {{- include "mnemoshare.labels" . | nindent 4 }}
    app.kubernetes.io/component: step-ca
    mnemoshare.com/hsm-enabled: "true"
type: Opaque
data:
  {{- if .Values.stepCA.hsm.pkcs11.pin }}
  pin: {{ .Values.stepCA.hsm.pkcs11.pin | toString | b64enc | quote }}
  {{- else }}
  # WARNING: No HSM PIN provided. This must be set for HSM mode to work.
  # Use stepCA.hsm.pkcs11.pin or stepCA.hsm.pkcs11.existingPinSecret
  pin: {{ "" | b64enc | quote }}
  {{- end }}
{{- end }}
