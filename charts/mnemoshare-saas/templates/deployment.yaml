apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mnemoshare-saas.fullname" . }}
  labels:
    {{- include "mnemoshare-saas.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.app.enabled }}
  replicas: {{ include "mnemoshare-saas.appReplicas" . }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mnemoshare-saas.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
  template:
    metadata:
      annotations:
        checksum/secrets: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
        {{- with .Values.app.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "mnemoshare-saas.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: api
        mnemoshare.io/customer-id: {{ .Values.customer.id | quote }}
        mnemoshare.io/tier: {{ .Values.tier | quote }}
    spec:
      serviceAccountName: {{ include "mnemoshare-saas.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: mnemoshare
        securityContext:
          {{- toYaml .Values.securityContext | nindent 12 }}
        image: "{{ .Values.app.image.repository }}:{{ .Values.app.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.app.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.targetPort }}
          protocol: TCP
        {{- if .Values.existingConfigMap }}
        envFrom:
        - configMapRef:
            name: {{ .Values.existingConfigMap }}
        {{- end }}
        env:
        # Database Configuration
        - name: DB_DRIVER
          value: "mongodb"
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingDatabaseSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: mongodb-uri
        - name: MONGODB_DATABASE
          value: {{ include "mnemoshare-saas.databaseName" . | quote }}
        
        # S3 Storage (DigitalOcean Spaces)
        - name: S3_ENDPOINT
          value: {{ .Values.storage.endpoint | quote }}
        - name: S3_REGION
          value: {{ .Values.storage.region | quote }}
        - name: S3_BUCKET
          value: {{ include "mnemoshare-saas.storageBucket" . | quote }}
        - name: S3_PREFIX
          value: {{ include "mnemoshare-saas.storagePrefix" . | quote }}
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingStorageSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: s3-access-key
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingStorageSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: s3-secret-key
        - name: S3_USE_SSL
          value: "true"
        
        # JWT Authentication
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingJWTSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: jwt-secret
        - name: JWT_EXPIRATION
          value: {{ .Values.jwt.expiration | quote }}
        
        # Encryption
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingEncryptionSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: encryption-key
        
        # License
        - name: LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingLicenseSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: license-key
        
        # Redis (Shared Sentinel - for workflow triggering)
        {{- if or .Values.redis.url .Values.existingRedisSecret }}
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingRedisSecret | default (include "mnemoshare-saas.secretsName" .) }}
              key: redis-url
        {{- end }}
        
        # Centralized ICAP (ClamAV)
        {{- if .Values.icap.url }}
        - name: DEFAULT_ICAP_URL
          value: {{ .Values.icap.url | quote }}
        - name: DEFAULT_ICAP_SERVICE
          value: {{ .Values.icap.service | quote }}
        {{- end }}

        # Centralized Presidio (NER-based DLP scanning)
        {{- if .Values.presidio.url }}
        - name: PRESIDIO_ENABLED
          value: "true"
        - name: PRESIDIO_URL
          value: {{ .Values.presidio.url | quote }}
        {{- if .Values.presidio.minConfidence }}
        - name: PRESIDIO_MIN_CONFIDENCE
          value: {{ .Values.presidio.minConfidence | quote }}
        {{- end }}
        {{- end }}

        # Centralized Step-CA (sensitive credentials from secret)
        {{- if and .Values.stepCA .Values.stepCA.enabled .Values.existingStepCASecret }}
        - name: CA_SMALLSTEP_PROVISIONER_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingStepCASecret }}
              key: provisioner-encrypted-key
        - name: CA_SMALLSTEP_PROVISIONER_PASS
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingStepCASecret }}
              key: provisioner-password
        - name: CA_SMALLSTEP_ROOT_CERT_PEM
          valueFrom:
            secretKeyRef:
              name: {{ .Values.existingStepCASecret }}
              key: root-ca-cert
        {{- end }}

        # MCP Server API key
        {{- if and .Values.mcp .Values.mcp.enabled .Values.mcp.apiKey .Values.mcp.apiKey.existingSecret }}
        - name: MCP_SHARED_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.mcp.apiKey.existingSecret }}
              key: mcp-api-key
        {{- end }}

        # Application settings
        - name: API_HOST
          value: "0.0.0.0"
        - name: API_PORT
          value: "8080"
        - name: APP_URL
          value: {{ include "mnemoshare-saas.appUrl" . | quote }}
        
        # Pod identity for peer discovery
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: HEADLESS_SERVICE_NAME
          value: {{ include "mnemoshare-saas.fullname" . }}-headless
        
        # Customer metadata
        - name: CUSTOMER_ID
          value: {{ .Values.customer.id | quote }}
        - name: CUSTOMER_TIER
          value: {{ .Values.tier | quote }}
        
        {{- with .Values.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        
        livenessProbe:
          {{- toYaml .Values.livenessProbe | nindent 12 }}
        readinessProbe:
          {{- toYaml .Values.readinessProbe | nindent 12 }}
        resources:
          {{- include "mnemoshare-saas.appResources" . | nindent 12 }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 1Gi
      {{- with .Values.app.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.app.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.app.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
